# Architecture

> Auto-generated by /map on 2026-02-10

## Overview

Whisper Network is a private messaging and identity platform built on the Midnight blockchain. It leverages Zero-Knowledge (ZK) proofs to provide secure, anonymous communication while maintaining a verifiable registry of handles and identities.

```
┌─────────────────────────────────────────┐
│              Next.js UI                 │
│         (app/ components/)              │
├─────────────────────────────────────────┤
│         Midnight JS SDK / Hooks         │
│         (lib/ hooks/)                   │
├─────────────────────────────────────────┤
│         Compact ZK Smart Contracts      │
│         (contracts/)                    │
└─────────────────────────────────────────┘
```

## Components

### Frontend (Next.js)
- **Purpose:** User interface for messaging, inbox management, and identity setup.
- **Location:** `app/` (App Router) and `components/`.
- **Key Modules:** `app/inbox/`, `components/MidnightWallet.tsx`.

### Private State Management
- **Purpose:** Handling user's private data and wallet interactions.
- **Location:** `hooks/` and `lib/midnight-setup.ts`.
- **Dependencies:** `@midnight-ntwrk/compact-runtime`, `@meshsdk/midnight-setup`.

### ZK Smart Contracts (Compact)
- **Purpose:** On-chain registry for handles and public keys with privacy guarantees.
- **Location:** `contracts/`.
- **Key Files:** `WhisperRegistry.compact`, `WhisperDNS.compact`.

### Storage & Proofs
- **Purpose:** IPFS for message storage and Circom/SnarkJS for custom ZK circuits.
- **Location:** `lib/ipfs.ts`, `circuits/`.

## Data Flow

1. **User Identity:** User creates a handle in the UI -> `register_handle` circuit executes -> proof submitted to Midnight ledger -> handle stored in `WhisperRegistry.compact`.
2. **Messaging:** Message encrypted with recipient's public key (resolved via `resolve_key`) -> Encrypted blob stored on IPFS -> Metadata posted to relayer/ledger.
3. **Consumption:** Recipient fetches encrypted message from IPFS -> Decrypts locally using private key stored in private state.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| Midnight Ledger | Blockchain | Private smart contract execution and settlement |
| Pinata (IPFS) | Storage | Decentralized storage for encrypted messages |
| Circom / SnarkJS | ZK Circuits | Custom proof generation (e.g., EmailOwnership) |

## Technical Debt

- [ ] Missing formal unit tests for Compact contracts.
- [ ] Relayer integration (`/api/relayer`) needs verification for production readiness.
- [ ] Error handling in `lib/midnight-setup.ts` could be more robust.

## Conventions

**Naming:** PascalCase for React components, snake_case/camelCase for Compact and TypeScript logic.
**Structure:** Feature-based routing in `app/`, shared logic in `lib/`.
**Testing:** Currently minimal; patterns should involve standard Next.js and Midnight SDK testing tools.
